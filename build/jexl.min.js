!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).Jexl=e()}(this,function(){"use strict";function o(t,e,r,n,a){void 0===a&&(a=Promise),this._grammar=t,this._transforms=e||{},this._context=r||{},this._relContext=n||this._context,this.Promise=a}var r={ArrayLiteral:function(t){return this.evalArray(t.value)},BinaryExpression:function(e){var r=this;return this.Promise.all([this.eval(e.left),this.eval(e.right)]).then(function(t){return r._grammar[e.operator].eval(t[0],t[1])})},ConditionalExpression:function(e){var r=this;return this.eval(e.test).then(function(t){return t?e.consequent?r.eval(e.consequent):t:r.eval(e.alternate)})},FilterExpression:function(e){var r=this;return this.eval(e.subject).then(function(t){return e.relative?r._filterRelative(t,e.expr):r._filterStatic(t,e.expr)})},Identifier:function(e){return e.from?this.eval(e.from).then(function(t){if(null!=t)return Array.isArray(t)&&(t=t[0]),t[e.value]}):e.relative?this._relContext[e.value]:this._context[e.value]},Literal:function(t){return t.value},ObjectLiteral:function(t){return this.evalMap(t.value)},Transform:function(t){var e=this._transforms[t.name];if(!e)throw new Error("Transform "+t.name+" is not defined.");return this.Promise.all([this.eval(t.subject),this.evalArray(t.args||[])]).then(function(t){return e.apply(null,[t[0]].concat(t[1]))})},UnaryExpression:function(e){var r=this;return this.eval(e.right).then(function(t){return r._grammar[e.operator].eval(t)})}};o.prototype.eval=function(t){var e=this;return this.Promise.resolve().then(function(){return r[t.type].call(e,t)})},o.prototype.evalArray=function(t){var e=this;return this.Promise.all(t.map(function(t){return e.eval(t)}))},o.prototype.evalMap=function(e){var r=this,n=Object.keys(e),a={},t=n.map(function(t){return r.eval(e[t])});return this.Promise.all(t).then(function(t){return t.forEach(function(t,e){a[n[e]]=t}),a})},o.prototype._filterRelative=function(n,r){var a=this,i=[];return Array.isArray(n)||(n=void 0===n?[]:[n]),n.forEach(function(t){var e=new o(a._grammar,a._transforms,a._context,t,a.Promise);i.push(e.eval(r))}),this.Promise.all(i).then(function(t){var r=[];return t.forEach(function(t,e){t&&r.push(n[e])}),r})},o.prototype._filterStatic=function(e,t){return this.eval(t).then(function(t){return"boolean"==typeof t?t?e:void 0:e[t]})};function t(t){this._grammar=t}var a=o,n=/^-?(?:(?:[0-9]*\.[0-9]+)|[0-9]+)$/,i=/^[a-zA-Z_$][a-zA-Z0-9_$]*$/,s=/\\\\/,e=/^\s*$/,p=["'(?:(?:\\\\')|[^'])*'",'"(?:(?:\\\\")|[^"])*"',"\\s+","\\btrue\\b","\\bfalse\\b"],u=["[a-zA-Z_\\$][a-zA-Z0-9_\\$]*","(?:(?:[0-9]*\\.[0-9]+)|[0-9]+)"],c=["binaryOp","unaryOp","openParen","openBracket","question","colon"];t.prototype.getElements=function(t){var e=this._getSplitRegex();return t.split(e).filter(function(t){return t})},t.prototype.getTokens=function(t){for(var e=[],r=!1,n=0;n<t.length;n++)this._isWhitespace(t[n])?e.length&&(e[e.length-1].raw+=t[n]):"-"===t[n]&&this._isNegative(e)?r=!0:(r&&(t[n]="-"+t[n],r=!1),e.push(this._createToken(t[n])));return r&&e.push(this._createToken("-")),e},t.prototype.tokenize=function(t){var e=this.getElements(t);return this.getTokens(e)},t.prototype._createToken=function(t){var e={type:"literal",value:t,raw:t};if('"'===t[0]||"'"===t[0])e.value=this._unquote(t);else if(t.match(n))e.value=parseFloat(t);else if("true"===t||"false"===t)e.value="true"===t;else if(this._grammar[t])e.type=this._grammar[t].type;else{if(!t.match(i))throw new Error("Invalid expression token: "+t);e.type="identifier"}return e},t.prototype._escapeRegExp=function(t){return(t=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")).match(i)&&(t="\\b"+t+"\\b"),t},t.prototype._getSplitRegex=function(){var t,e=this;return this._splitRegex||(t=Object.keys(this._grammar).sort(function(t,e){return e.length-t.length}).map(function(t){return e._escapeRegExp(t)},this),this._splitRegex=new RegExp("("+[p.join("|"),t.join("|"),u.join("|")].join("|")+")")),this._splitRegex},t.prototype._isNegative=function(e){return!e.length||c.some(function(t){return t===e[e.length-1].type})},t.prototype._isWhitespace=function(t){return!!t.match(e)},t.prototype._unquote=function(t){var e=t[0],r=new RegExp("\\\\"+e,"g");return t.substr(1,t.length-2).replace(r,e).replace(s,"\\")};function l(t,e,r){this._grammar=t,this._state="expectOperand",this._tree=null,this._exprStr=e||"",this._relative=!1,this._stopMap=r||{}}var h=t,f={argVal:function(t){this._cursor.args.push(t)},arrayStart:function(){this._placeAtCursor({type:"ArrayLiteral",value:[]})},arrayVal:function(t){t&&this._cursor.value.push(t)},binaryOp:function(t){for(var e=this._grammar[t.value].precedence||0,r=this._cursor._parent;r&&r.operator&&this._grammar[r.operator].precedence>=e;)r=(this._cursor=r)._parent;var n={type:"BinaryExpression",operator:t.value,left:this._cursor};this._setParent(this._cursor,n),this._cursor=r,this._placeAtCursor(n)},dot:function(){this._nextIdentEncapsulate=this._cursor&&"UnaryExpression"!==this._cursor.type&&("BinaryExpression"!==this._cursor.type||"BinaryExpression"===this._cursor.type&&this._cursor.right),this._nextIdentRelative=!this._cursor||this._cursor&&!this._nextIdentEncapsulate,this._nextIdentRelative&&(this._relative=!0)},filter:function(t){this._placeBeforeCursor({type:"FilterExpression",expr:t,relative:this._subParser.isRelative(),subject:this._cursor})},identifier:function(t){var e={type:"Identifier",value:t.value};this._nextIdentEncapsulate?(e.from=this._cursor,this._placeBeforeCursor(e),this._nextIdentEncapsulate=!1):(this._nextIdentRelative&&(e.relative=!0,this._nextIdentRelative=!1),this._placeAtCursor(e))},literal:function(t){this._placeAtCursor({type:"Literal",value:t.value})},objKey:function(t){this._curObjKey=t.value},objStart:function(){this._placeAtCursor({type:"ObjectLiteral",value:{}})},objVal:function(t){this._cursor.value[this._curObjKey]=t},subExpression:function(t){this._placeAtCursor(t)},ternaryEnd:function(t){this._cursor.alternate=t},ternaryMid:function(t){this._cursor.consequent=t},ternaryStart:function(){this._tree={type:"ConditionalExpression",test:this._tree},this._cursor=this._tree},transform:function(t){this._placeBeforeCursor({type:"Transform",name:t.value,args:[],subject:this._cursor})},unaryOp:function(t){this._placeAtCursor({type:"UnaryExpression",operator:t.value})}},y={states:{expectOperand:{tokenTypes:{literal:{toState:"expectBinOp"},identifier:{toState:"identifier"},unaryOp:{},openParen:{toState:"subExpression"},openCurl:{toState:"expectObjKey",handler:f.objStart},dot:{toState:"traverse"},openBracket:{toState:"arrayVal",handler:f.arrayStart}}},expectBinOp:{tokenTypes:{binaryOp:{toState:"expectOperand"},pipe:{toState:"expectTransform"},dot:{toState:"traverse"},question:{toState:"ternaryMid",handler:f.ternaryStart}},completable:!0},expectTransform:{tokenTypes:{identifier:{toState:"postTransform",handler:f.transform}}},expectObjKey:{tokenTypes:{identifier:{toState:"expectKeyValSep",handler:f.objKey},closeCurl:{toState:"expectBinOp"}}},expectKeyValSep:{tokenTypes:{colon:{toState:"objVal"}}},postTransform:{tokenTypes:{openParen:{toState:"argVal"},binaryOp:{toState:"expectOperand"},dot:{toState:"traverse"},openBracket:{toState:"filter"},pipe:{toState:"expectTransform"}},completable:!0},postTransformArgs:{tokenTypes:{binaryOp:{toState:"expectOperand"},dot:{toState:"traverse"},openBracket:{toState:"filter"},pipe:{toState:"expectTransform"}},completable:!0},identifier:{tokenTypes:{binaryOp:{toState:"expectOperand"},dot:{toState:"traverse"},openBracket:{toState:"filter"},pipe:{toState:"expectTransform"},question:{toState:"ternaryMid",handler:f.ternaryStart}},completable:!0},traverse:{tokenTypes:{identifier:{toState:"identifier"}}},filter:{subHandler:f.filter,endStates:{closeBracket:"identifier"}},subExpression:{subHandler:f.subExpression,endStates:{closeParen:"expectBinOp"}},argVal:{subHandler:f.argVal,endStates:{comma:"argVal",closeParen:"postTransformArgs"}},objVal:{subHandler:f.objVal,endStates:{comma:"expectObjKey",closeCurl:"expectBinOp"}},arrayVal:{subHandler:f.arrayVal,endStates:{comma:"arrayVal",closeBracket:"expectBinOp"}},ternaryMid:{subHandler:f.ternaryMid,endStates:{colon:"ternaryEnd"}},ternaryEnd:{subHandler:f.ternaryEnd,completable:!0}}}.states;l.prototype.addToken=function(t){if("complete"===this._state)throw new Error("Cannot add a new token to a completed Parser");var e=y[this._state],r=this._exprStr;if(this._exprStr+=t.raw,e.subHandler){this._subParser||this._startSubExpression(r);var n=this._subParser.addToken(t);if(n){if(this._endSubExpression(),this._parentStop)return n;this._state=n}}else{if(!e.tokenTypes[t.type]){if(this._stopMap[t.type])return this._stopMap[t.type];throw new Error("Token "+t.raw+" ("+t.type+") unexpected in expression: "+this._exprStr)}var a=e.tokenTypes[t.type],i=f[t.type];a.handler&&(i=a.handler),i&&i.call(this,t),a.toState&&(this._state=a.toState)}return!1},l.prototype.addTokens=function(t){t.forEach(this.addToken,this)},l.prototype.complete=function(){if(this._cursor&&!y[this._state].completable)throw new Error("Unexpected end of expression: "+this._exprStr);return this._subParser&&this._endSubExpression(),this._state="complete",this._cursor?this._tree:null},l.prototype.isRelative=function(){return this._relative},l.prototype._endSubExpression=function(){y[this._state].subHandler.call(this,this._subParser.complete()),this._subParser=null},l.prototype._placeAtCursor=function(t){this._cursor?(this._cursor.right=t,this._setParent(t,this._cursor)):this._tree=t,this._cursor=t},l.prototype._placeBeforeCursor=function(t){this._cursor=this._cursor._parent,this._placeAtCursor(t)},l.prototype._setParent=function(t,e){Object.defineProperty(t,"_parent",{value:e,writable:!0})},l.prototype._startSubExpression=function(t){var e=y[this._state].endStates;e||(this._parentStop=!0,e=this._stopMap),this._subParser=new l(this._grammar,t,e)};function _(t){t(this._resolve.bind(this),this._reject.bind(this))}var v=l;_.prototype.catch=function(t){if(this.error)try{this._resolve(t(this.error))}catch(t){this._reject(t)}return this},_.prototype.then=function(t,e){if(!this.error)try{this._resolve(t(this.value))}catch(t){this._reject(t)}return e&&this.catch(e),this},_.prototype._reject=function(t){this.value=void 0,this.error=t},_.prototype._resolve=function(t){t instanceof _?t.error?this._reject(t.error):this._resolve(t.value):(this.value=t,this.error=void 0)},_.all=function(e){return new _(function(t){t(e.map(function(t){for(;t instanceof _;){if(t.error)throw Error(t.error);t=t.value}return t}))})},_.resolve=function(e){return new _(function(t){return t(e)})},_.reject=function(r){return new _(function(t,e){return e(r)})};function d(t,e){this._lang=t,this._lexer=new h(t.grammar),this._exprStr=e,this._ast=null}var m=_;d.prototype.compile=function(){var t=new h(this._lang.grammar),e=new v(this._lang.grammar),r=t.tokenize(this._exprStr);return e.addTokens(r),this._ast=e.complete(),this},d.prototype.eval=function(t){return void 0===t&&(t={}),this._eval(t,Promise)},d.prototype.evalSync=function(t){void 0===t&&(t={});var e=this._eval(t,m);if(e.error)throw e.error;return e.value},d.prototype._eval=function(e,r){var n=this;return r.resolve().then(function(){var t=n._getAst();return new a(n._lang.grammar,n._lang.transforms,e,void 0,r).eval(t)})},d.prototype._getAst=function(){return this._ast||this.compile(),this._ast};function x(){this.expr=this.expr.bind(this),this._grammar=Object.assign({},g),this._lexer=null,this._transforms={}}var b=d,g={elements:{".":{type:"dot"},"[":{type:"openBracket"},"]":{type:"closeBracket"},"|":{type:"pipe"},"{":{type:"openCurl"},"}":{type:"closeCurl"},":":{type:"colon"},",":{type:"comma"},"(":{type:"openParen"},")":{type:"closeParen"},"?":{type:"question"},"+":{type:"binaryOp",precedence:30,eval:function(t,e){return t+e}},"-":{type:"binaryOp",precedence:30,eval:function(t,e){return t-e}},"*":{type:"binaryOp",precedence:40,eval:function(t,e){return t*e}},"/":{type:"binaryOp",precedence:40,eval:function(t,e){return t/e}},"//":{type:"binaryOp",precedence:40,eval:function(t,e){return Math.floor(t/e)}},"%":{type:"binaryOp",precedence:50,eval:function(t,e){return t%e}},"^":{type:"binaryOp",precedence:50,eval:function(t,e){return Math.pow(t,e)}},"==":{type:"binaryOp",precedence:20,eval:function(t,e){return t==e}},"!=":{type:"binaryOp",precedence:20,eval:function(t,e){return t!=e}},">":{type:"binaryOp",precedence:20,eval:function(t,e){return e<t}},">=":{type:"binaryOp",precedence:20,eval:function(t,e){return e<=t}},"<":{type:"binaryOp",precedence:20,eval:function(t,e){return t<e}},"<=":{type:"binaryOp",precedence:20,eval:function(t,e){return t<=e}},"&&":{type:"binaryOp",precedence:10,eval:function(t,e){return t&&e}},"||":{type:"binaryOp",precedence:10,eval:function(t,e){return t||e}},in:{type:"binaryOp",precedence:20,eval:function(e,t){return"string"==typeof t?-1!==t.indexOf(e):!!Array.isArray(t)&&t.some(function(t){return t===e})}},"!":{type:"unaryOp",precedence:1/0,eval:function(t){return!t}}}}.elements;x.prototype.addBinaryOp=function(t,e,r){this._addGrammarElement(t,{type:"binaryOp",precedence:e,eval:r})},x.prototype.addUnaryOp=function(t,e){this._addGrammarElement(t,{type:"unaryOp",weight:1/0,eval:e})},x.prototype.addTransform=function(t,e){this._transforms[t]=e},x.prototype.addTransforms=function(t){for(var e in t)t.hasOwnProperty(e)&&(this._transforms[e]=t[e])},x.prototype.compile=function(t){return this.createExpression(t).compile()},x.prototype.createExpression=function(t){var e=this._getLang();return new b(e,t)},x.prototype.getTransform=function(t){return this._transforms[t]},x.prototype.eval=function(t,e){return void 0===e&&(e={}),this.createExpression(t).eval(e)},x.prototype.evalSync=function(t,e){return void 0===e&&(e={}),this.createExpression(t).evalSync(e)},x.prototype.expr=function(t){for(var n=[],e=arguments.length-1;0<e--;)n[e]=arguments[e+1];var r=t.reduce(function(t,e,r){return t+=e+(r<n.length?n[r]:"")},"");return this.createExpression(r)},x.prototype.removeOp=function(t){!this._grammar[t]||"binaryOp"!==this._grammar[t].type&&"unaryOp"!==this._grammar[t].type||delete this._grammar[t]},x.prototype._addGrammarElement=function(t,e){this._grammar[t]=e},x.prototype._getLang=function(){return{grammar:this._grammar,transforms:this._transforms}};var S=x;return(new x).Jexl=S});
//# sourceMappingURL=jexl.min.js.map
